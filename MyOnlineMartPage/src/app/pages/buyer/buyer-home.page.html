<section class="page">
  <div class="page-header">
    <div>
      <h1 class="page-title">Order Summary</h1>
      <p class="page-subtitle">
        Review your full order history and the items you purchase most often.
      </p>
    </div>
    <a class="btn primary" routerLink="/buyer/products">Shop products</a>
  </div>

  @if (errorMessage()) {
    <div class="alert">{{ errorMessage() }}</div>
  }

  <div class="split">
    <div class="card">
      <div class="page-header">
        <h3>Order History</h3>
        <button class="btn secondary" type="button" (click)="loadData()">Refresh</button>
      </div>

      @if (orders().length === 0) {
        <div class="helper">No orders yet. Start by placing your first order.</div>
      } @else {
        <table class="table">
          <thead>
            <tr>
              <th>Order</th>
              <th>Placed</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            @for (order of orders(); track order.id) {
              <tr>
                <td>#{{ order.id }}</td>
                <td>{{ formatDate(order.placedAt) }}</td>
                <td>
                  <span class="badge" [class.processing]="order.status === 'PROCESSING'"
                    [class.completed]="order.status === 'COMPLETED'"
                    [class.canceled]="order.status === 'CANCELED'">
                    {{ order.status }}
                  </span>
                </td>
                <td>
                  <div class="list" style="flex-direction: row; gap: 0.4rem;">
                    <button class="btn tiny secondary" type="button" (click)="viewOrder(order.id)">
                      View
                    </button>
                    <button
                      class="btn tiny ghost"
                      type="button"
                      [disabled]="order.status !== 'PROCESSING'"
                      (click)="cancelOrder(order.id)"
                    >
                      Cancel
                    </button>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      }
    </div>

    <div class="list">
      <div class="card">
        <h3>Top 3 Frequent Items</h3>
        @if (frequentItems().length === 0) {
          <div class="helper">No purchase history yet.</div>
        } @else {
          <div class="list">
            @for (item of frequentItems(); track item.productId) {
              <div class="list-item">
                <div>
                  <strong>{{ item.description ?? ('Product #' + item.productId) }}</strong>
                  <div class="helper">Total qty: {{ item.totalQuantity ?? '-' }}</div>
                </div>
              </div>
            }
          </div>
        }
      </div>

      <div class="card">
        <h3>Top 3 Recent Items</h3>
        @if (recentItems().length === 0) {
          <div class="helper">No recent items yet.</div>
        } @else {
          <div class="list">
            @for (item of recentItems(); track item.productId) {
              <div class="list-item">
                <div>
                  <strong>{{ item.description ?? ('Product #' + item.productId) }}</strong>
                  <div class="helper">Last bought: {{ item.lastPurchasedAt ?? '-' }}</div>
                </div>
              </div>
            }
          </div>
        }
      </div>
    </div>
  </div>
</section>
